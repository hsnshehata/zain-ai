// /public/js/storeManager.js
async function loadStoreManagerPage() {
  console.log('๐ loadStoreManagerPage called');
  const link = document.createElement("link");
  link.rel = "stylesheet";
  link.href = "/css/storeManager.css";
  document.head.appendChild(link);
  const content = document.getElementById("content");
  const token = localStorage.getItem("token");
  const selectedBotId = localStorage.getItem("selectedBotId");

  if (!selectedBotId) {
    content.innerHTML = `
      <div class="placeholder error">
        <h2><i class="fas fa-exclamation-triangle"></i> ูู ูุชู ุงุฎุชูุงุฑ ุจูุช</h2>
        <p>ูุฑุฌู ุงุฎุชูุงุฑ ุจูุช ูู ุงููุงุฆูุฉ ุงูุนูููุฉ ุฃููุงู ูุนุฑุถ ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ.</p>
      </div>
    `;
    return;
  }

  if (!token) {
    content.innerHTML = `
      <div class="placeholder error">
        <h2><i class="fas fa-exclamation-triangle"></i> ุชุณุฌูู ุงูุฏุฎูู ูุทููุจ</h2>
        <p>ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุนุฑุถ ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ.</p>
      </div>
    `;
    return;
  }

  // Main structure for the store settings page
  content.innerHTML = `
    <div class="page-header">
      <h2><i class="fas fa-store"></i> ุฅุฏุงุฑุฉ ุงููุชุฌุฑ ุงูุฐูู</h2>
      <div id="instructionsContainer" class="instructions-container" style="display: none;">
        <h3>๐ ุฎุทูุงุช ุฅูุดุงุก ูุฅุฏุงุฑุฉ ูุชุฌุฑู ุงูุฐูู</h3>
        <p>ุนุดุงู ุชูุฏุฑ ุชุฏูุฑ ูุชุฌุฑู ุจุณูููุฉุ ุงุชูุจุน ุงูุฎุทูุงุช ุฏู:</p>
        <ul>
          <li>
            <strong>1. ุฅูุดุงุก ุงููุชุฌุฑ:</strong> ูู ูุณู ูุงุนููุชุด ูุชุฌุฑุ ุงููุฃ ุจูุงูุงุช ุงููุชุฌุฑ (ุงูุงุณูุ ุงููุงูุจุ ุงูุฃููุงู) ูุงุถุบุท "ุญูุธ ุงููุชุฌุฑ".
          </li>
          <li>
            <strong>2. ุฅุถุงูุฉ ุงูููุชุฌุงุช:</strong> ุฃุถู ููุชุฌุงุชู ุจุงูุงุณูุ ุงููุตูุ ุงูุณุนุฑุ ุงูุตูุฑุฉุ ูุงููุฎุฒูู.
            <br>
            <span style="display: block; margin-top: 5px;">
              - ุงูุตูุฑ ูุงุฒู ุชููู ุจุตูุบุฉ PNG ุฃู JPGุ ูููุถู ุชููู ูุฑุจุนุฉ.<br>
              - ุญุฏุฏ ุนุชุจุฉ ุงููุฎุฒูู ุงูููุฎูุถ ุนุดุงู ุชุชููู ุฅุดุนุงุฑุงุช ูู ุงููุฎุฒูู ูู.
            </span>
          </li>
          <li>
            <strong>3. ุชุฎุตูุต ุงููุงุฌูุฉ:</strong> ุงุฎุชุงุฑ ูุงูุจ (ููุงุณูููุ ููุฏุฑูุ ุฅูุฎ)ุ ูุนุฏูู ุงูุฃููุงู ุฃู ุฃุถู HTML ูุฎุตุต ููููุฏุฑ ุฃู ุงููุงูุฏููุฌ ุจูุฌ.
          </li>
          <li>
            <strong>4. ุฅุฏุงุฑุฉ ุงูุทูุจุงุช:</strong> ุงูุทูุจุงุช ูุชุธูุฑ ูู ุตูุญุฉ ุงูุญุณุงุจุงุช (ุชุญุช ุงูุฅูุดุงุก) ูุน ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ููุงุชุณุงุจ.
          </li>
        </ul>
      </div>
      <div class="header-actions">
        <button id="toggleInstructionsBtn" class="btn btn-secondary"><i class="fas fa-info-circle"></i> ุฅุธูุงุฑ ุงูุชุนูููุงุช</button>
        <div id="storeStatus" class="page-status" style="margin-left: 20px;"></div>
      </div>
    </div>

    <div id="loadingSpinner" class="spinner"><div class="loader"></div></div>
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <div id="storeSettingsContainer" class="settings-container store-settings-grid" style="display: none;">
      <div class="card settings-card">
        <div class="card-header"><h3><i class="fas fa-store-alt"></i> ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ</h3></div>
        <div class="card-body">
          <form id="store-form">
            <div class="form-group">
              <label for="storeName">ุงุณู ุงููุชุฌุฑ</label>
              <input type="text" id="storeName" name="storeName" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="templateId">ุงููุงูุจ</label>
              <select id="templateId" name="templateId" class="form-control">
                <option value="1">ููุงุณููู</option>
                <option value="2">ููุฏุฑู</option>
                <option value="3">ุจุณูุท</option>
                <option value="4">ุฅุจุฏุงุนู</option>
                <option value="5">ุชุฌุงุฑู</option>
              </select>
            </div>
            <div class="form-group">
              <label for="primaryColor">ุงูููู ุงูุฃุณุงุณู</label>
              <input type="color" id="primaryColor" name="primaryColor" class="form-control">
            </div>
            <div class="form-group">
              <label for="secondaryColor">ุงูููู ุงูุซุงููู</label>
              <input type="color" id="secondaryColor" name="secondaryColor" class="form-control">
            </div>
            <div class="form-group">
              <label for="headerHtml">ููุฏ HTML ููููุฏุฑ</label>
              <textarea id="headerHtml" name="headerHtml" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label for="landingTemplateId">ูุงูุจ ุงููุงูุฏููุฌ ุจูุฌ</label>
              <select id="landingTemplateId" name="landingTemplateId" class="form-control">
                <option value="1">ููุงุณููู</option>
                <option value="2">ููุฏุฑู</option>
                <option value="3">ุจุณูุท</option>
                <option value="4">ุฅุจุฏุงุนู</option>
                <option value="5">ุชุฌุงุฑู</option>
              </select>
            </div>
            <div class="form-group">
              <label for="landingHtml">ููุฏ HTML ููุงูุฏููุฌ ุจูุฌ</label>
              <textarea id="landingHtml" name="landingHtml" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">ุญูุธ ุงููุชุฌุฑ</button>
            </div>
          </form>
          <p id="storeError" class="error-message" style="display: none;"></p>
        </div>
      </div>
      <div class="card settings-card">
        <div class="card-header"><h3><i class="fas fa-box"></i> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</h3></div>
        <div class="card-body">
          <form id="product-form">
            <div class="form-group">
              <label for="productName">ุงุณู ุงูููุชุฌ</label>
              <input type="text" id="productName" name="productName" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="description">ุงููุตู</label>
              <textarea id="description" name="description" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="price">ุงูุณุนุฑ</label>
              <input type="number" id="price" name="price" class="form-control" required min="0">
            </div>
            <div class="form-group">
              <label for="currency">ุงูุนููุฉ</label>
              <select id="currency" name="currency" class="form-control">
                <option value="EGP">ุฌููู ูุตุฑู</option>
                <option value="USD">ุฏููุงุฑ ุฃูุฑููู</option>
                <option value="SAR">ุฑูุงู ุณุนูุฏู</option>
                <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู</option>
              </select>
            </div>
            <div class="form-group">
              <label for="image">ุตูุฑุฉ ุงูููุชุฌ</label>
              <input type="file" id="image" name="image" class="form-control" accept="image/*">
            </div>
            <div class="form-group">
              <label for="stock">ุงููุฎุฒูู</label>
              <input type="number" id="stock" name="stock" class="form-control" required min="0">
            </div>
            <div class="form-group">
              <label for="lowStockThreshold">ุนุชุจุฉ ุงููุฎุฒูู ุงูููุฎูุถ</label>
              <input type="number" id="lowStockThreshold" name="lowStockThreshold" class="form-control" min="0" value="10">
            </div>
            <div class="form-group">
              <label for="category">ุงูุชุตููู</label>
              <input type="text" id="category" name="category" class="form-control">
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">ุฅุถุงูุฉ ุงูููุชุฌ</button>
            </div>
          </form>
          <p id="productError" class="error-message" style="display: none;"></p>
          <div id="productsList" class="products-grid"></div>
        </div>
      </div>
    </div>
  `;

  const loadingSpinner = document.getElementById("loadingSpinner");
  const errorMessage = document.getElementById("errorMessage");
  const storeSettingsContainer = document.getElementById("storeSettingsContainer");
  const instructionsContainer = document.getElementById("instructionsContainer");
  const toggleInstructionsBtn = document.getElementById("toggleInstructionsBtn");
  const storeStatus = document.getElementById("storeStatus");
  const storeForm = document.getElementById("store-form");
  const productForm = document.getElementById("product-form");
  const storeError = document.getElementById("storeError");
  const productError = document.getElementById("productError");
  const productsList = document.getElementById("productsList");

  // --- Functions ---

  async function handleApiRequest(url, options, errorElement, defaultErrorMessage) {
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          throw new Error("ุงูุฑุฏ ุบูุฑ ูุชููุน (ูุด JSON). ูููู ุฅู ุงูุฎุฏูุฉ ูุด ูุชุงุญุฉ.");
        }
        const errorData = await response.json();
        throw new Error(errorData.message || defaultErrorMessage);
      }
      return await response.json();
    } catch (err) {
      if (errorElement) {
        errorElement.textContent = err.message;
        errorElement.style.display = "block";
      }
      throw err;
    }
  }

  async function loadStoreStatus(botId) {
    console.log(`ุฌุงุฑู ุฌูุจ ุจูุงูุงุช ุงูุจูุช ุจุงูู ID: ${botId}`);
    try {
      const bot = await handleApiRequest(`/api/bots/${botId}`, {
        headers: { Authorization: `Bearer ${token}` },
      }, storeStatus, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช");

      if (!bot) {
        console.log(`ุงูุจูุช ุจุงูู ID ${botId} ูุด ููุฌูุฏ`);
        storeStatus.innerHTML = `
          <div style="display: inline-block; color: red;">
            <strong>ุญุงูุฉ ุงููุชุฌุฑ:</strong> ุบูุฑ ููุฌูุฏ โ<br>
            <strong>ุงูุณุจุจ:</strong> ุงูุจูุช ุบูุฑ ููุฌูุฏ ุฃู ุชู ุญุฐูู
          </div>
        `;
        instructionsContainer.style.display = "block";
        return;
      }

      console.log(`ุจูุงูุงุช ุงูุจูุช:`, bot);

      if (bot.storeId) {
        const store = await handleApiRequest(`/api/stores/${bot.storeId}`, {
          headers: { Authorization: `Bearer ${token}` },
        }, storeStatus, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงููุชุฌุฑ");

        console.log(`ุชู ุฌูุจ ุจูุงูุงุช ุงููุชุฌุฑ ุจูุฌุงุญ:`, store);
        const statusDiv = document.createElement("div");
        statusDiv.style.display = "inline-block";
        statusDiv.style.color = "green";
        statusDiv.innerHTML = `
          <strong>ุญุงูุฉ ุงููุชุฌุฑ:</strong> ููุนูู โ<br>
          <strong>ุงุณู ุงููุชุฌุฑ:</strong> ${store.storeName}<br>
          <strong>ุชุงุฑูุฎ ุงูุฅูุดุงุก:</strong> ${new Date(store.createdAt).toLocaleString('ar-EG')}
        `;

        const deleteStoreBtn = document.createElement("button");
        deleteStoreBtn.id = "deleteStoreBtn";
        deleteStoreBtn.className = "btn btn-danger";
        deleteStoreBtn.style.marginLeft = "10px";
        deleteStoreBtn.style.backgroundColor = "#dc3545";
        deleteStoreBtn.style.borderColor = "#dc3545";
        deleteStoreBtn.textContent = "ุญุฐู ุงููุชุฌุฑ";

        deleteStoreBtn.addEventListener("click", async () => {
          if (confirm("ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุชุฌุฑุ")) {
            try {
              await handleApiRequest(`/api/stores/${bot.storeId}`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
              }, errorMessage, "ูุดู ูู ุญุฐู ุงููุชุฌุฑ");

              errorMessage.textContent = "ุชู ุญุฐู ุงููุชุฌุฑ ุจูุฌุงุญ!";
              errorMessage.style.color = "green";
              errorMessage.style.display = "block";
              await loadStoreStatus(botId);
              await loadStoreSettings(botId);
            } catch (err) {
              console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุชุฌุฑ:', err);
              errorMessage.textContent = 'ุฎุทุฃ ูู ุญุฐู ุงููุชุฌุฑ: ' + (err.message || 'ุบูุฑ ูุนุฑูู');
              errorMessage.style.color = "red";
              errorMessage.style.display = "block";
            }
          }
        });

        storeStatus.innerHTML = "";
        storeStatus.appendChild(statusDiv);
        storeStatus.appendChild(deleteStoreBtn);
        instructionsContainer.style.display = "none";
      } else {
        console.log(`ุงูุจูุช ูุด ูุฑุชุจุท ุจูุชุฌุฑ`);
        storeStatus.innerHTML = `
          <div style="display: inline-block; color: red;">
            <strong>ุญุงูุฉ ุงููุชุฌุฑ:</strong> ุบูุฑ ููุฌูุฏ โ
          </div>
        `;
        instructionsContainer.style.display = "block";
      }
    } catch (err) {
      console.error('Error loading store status:', err);
      storeStatus.innerHTML = `
        <div style="display: inline-block; color: red;">
          <strong>ุญุงูุฉ ุงููุชุฌุฑ:</strong> ุบูุฑ ููุฌูุฏ โ<br>
          <strong>ุงูุณุจุจ:</strong> ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช: ${err.message || 'ุบูุฑ ูุนุฑูู'}
        </div>
      `;
      instructionsContainer.style.display = "block";
    }
  }

  async function loadStoreSettings(botId) {
    loadingSpinner.style.display = "flex";
    storeSettingsContainer.style.display = "none";
    errorMessage.style.display = "none";

    try {
      const bot = await handleApiRequest(`/api/bots/${botId}`, {
        headers: { Authorization: `Bearer ${token}` },
      }, errorMessage, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช");

      if (bot.storeId) {
        const store = await handleApiRequest(`/api/stores/${bot.storeId}`, {
          headers: { Authorization: `Bearer ${token}` },
        }, errorMessage, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงููุชุฌุฑ");

        document.getElementById("storeName").value = store.storeName || '';
        document.getElementById("templateId").value = store.templateId || '1';
        document.getElementById("primaryColor").value = store.primaryColor || '#000000';
        document.getElementById("secondaryColor").value = store.secondaryColor || '#ffffff';
        document.getElementById("headerHtml").value = store.headerHtml || '';
        document.getElementById("landingTemplateId").value = store.landingTemplateId || '1';
        document.getElementById("landingHtml").value = store.landingHtml || '';
        storeSettingsContainer.style.display = "grid";
      } else {
        storeSettingsContainer.style.display = "grid";
      }
    } catch (err) {
      console.error('ุฎุทุฃ ูู ุชุญููู ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ:', err);
      errorMessage.textContent = "ุชุนุฐุฑ ุชุญููู ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑุ ุญุงูู ูุงุญููุง ุฃู ุชูุงุตู ูุน ุงูุฏุนู.";
      errorMessage.style.display = "block";
    } finally {
      loadingSpinner.style.display = "none";
    }
  }

  async function loadProducts(botId) {
    try {
      const bot = await handleApiRequest(`/api/bots/${botId}`, {
        headers: { Authorization: `Bearer ${token}` },
      }, productError, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช");

      if (bot.storeId) {
        const products = await handleApiRequest(`/api/stores/${bot.storeId}/products`, {
          headers: { Authorization: `Bearer ${token}` },
        }, productError, "ูุดู ูู ุฌูุจ ุงูููุชุฌุงุช");

        productsList.innerHTML = products.length === 0
          ? '<p>ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ุงููุชุฌุฑ.</p>'
          : products.map(product => `
              <div class="product-card">
                <img src="${product.imageUrl || '/placeholder-bot.png'}" alt="${product.productName}">
                <h3>${product.productName}</h3>
                <p>ุงูุณุนุฑ: ${product.price} ${product.currency}</p>
                <p>ุงููุฎุฒูู: ${product.stock}</p>
                <button onclick="editProduct('${product._id}')">ุชุนุฏูู</button>
                <button onclick="deleteProduct('${product._id}')">ุญุฐู</button>
              </div>
            `).join('');
      } else {
        productsList.innerHTML = '<p>ูุง ููุฌุฏ ูุชุฌุฑ ูุฑุชุจุท ุจุงูุจูุชุ ุฃูุดุฆ ูุชุฌุฑ ุฃููุงู.</p>';
      }
    } catch (err) {
      console.error("ุฎุทุฃ ูู ุฌูุจ ุงูููุชุฌุงุช:", err);
      productError.textContent = err.message || "ูุดู ูู ุฌูุจ ุงูููุชุฌุงุช";
      productError.style.display = "block";
    }
  }

  async function saveStoreSettings(botId) {
    storeError.style.display = "none";
    const storeName = document.getElementById("storeName").value.trim();
    if (!storeName) {
      storeError.textContent = "ุงุณู ุงููุชุฌุฑ ูุทููุจ";
      storeError.style.display = "block";
      return;
    }

    const formData = new FormData(storeForm);
    formData.append('botId', botId); // ุฅุถุงูุฉ botId ููุฑุจุท

    try {
      const bot = await handleApiRequest(`/api/bots/${botId}`, {
        headers: { Authorization: `Bearer ${token}` },
      }, storeError, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช");

      const method = bot.storeId ? 'PUT' : 'POST';
      const url = bot.storeId ? `/api/stores/${bot.storeId}` : '/api/stores';

      const response = await handleApiRequest(url, {
        method,
        headers: {
          Authorization: `Bearer ${token}`,
        },
        body: formData,
      }, storeError, "ูุดู ูู ุญูุธ ุงููุชุฌุฑ");

      storeError.textContent = `ุชู ุญูุธ ุงููุชุฌุฑ ูุฑุจุทู ุจุงูุจูุช ุจูุฌุงุญ!`;
      storeError.style.color = "green";
      storeError.style.display = "block";
      await loadStoreStatus(botId);
      await loadStoreSettings(botId);
      await loadProducts(botId);
    } catch (err) {
      console.error("ุฎุทุฃ ูู ุญูุธ ุงููุชุฌุฑ:", err);
    }
  }

  let editingProductId = null;
  async function saveProduct(botId) {
    productError.style.display = "none";
    const formData = new FormData(productForm);

    try {
      const bot = await handleApiRequest(`/api/bots/${botId}`, {
        headers: { Authorization: `Bearer ${token}` },
      }, productError, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช");

      if (!bot.storeId) {
        productError.textContent = "ุฃูุดุฆ ูุชุฌุฑ ุฃููุงู ูุจู ุฅุถุงูุฉ ุงูููุชุฌุงุช.";
        productError.style.display = "block";
        return;
      }

      const method = editingProductId ? 'PUT' : 'POST';
      const url = editingProductId
        ? `/api/stores/${bot.storeId}/products/${editingProductId}`
        : `/api/stores/${bot.storeId}/products`;

      await handleApiRequest(url, {
        method,
        headers: { Authorization: `Bearer ${token}` },
        body: formData,
      }, productError, "ูุดู ูู ุญูุธ ุงูููุชุฌ");

      productError.textContent = "ุชู ุญูุธ ุงูููุชุฌ ุจูุฌุงุญ!";
      productError.style.color = "green";
      productError.style.display = "block";
      productForm.reset();
      editingProductId = null;
      await loadProducts(botId);
    } catch (err) {
      console.error("ุฎุทุฃ ูู ุญูุธ ุงูููุชุฌ:", err);
    }
  }

  window.editProduct = async (productId) => {
    try {
      const bot = await handleApiRequest(`/api/bots/${selectedBotId}`, {
        headers: { Authorization: `Bearer ${token}` },
      }, productError, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช");

      const product = await handleApiRequest(`/api/stores/${bot.storeId}/products/${productId}`, {
        headers: { Authorization: `Bearer ${token}` },
      }, productError, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูููุชุฌ");

      document.getElementById("productName").value = product.productName;
      document.getElementById("description").value = product.description;
      document.getElementById("price").value = product.price;
      document.getElementById("currency").value = product.currency;
      document.getElementById("stock").value = product.stock;
      document.getElementById("lowStockThreshold").value = product.lowStockThreshold;
      document.getElementById("category").value = product.category;
      editingProductId = productId;
    } catch (err) {
      console.error("ุฎุทุฃ ูู ุชุญููู ุงูููุชุฌ:", err);
    }
  };

  window.deleteProduct = async (productId) => {
    if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุชุฌุ")) {
      try {
        const bot = await handleApiRequest(`/api/bots/${selectedBotId}`, {
          headers: { Authorization: `Bearer ${token}` },
        }, productError, "ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงูุจูุช");

        await handleApiRequest(`/api/stores/${bot.storeId}/products/${productId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` },
        }, productError, "ูุดู ูู ุญุฐู ุงูููุชุฌ");

        productError.textContent = "ุชู ุญุฐู ุงูููุชุฌ ุจูุฌุงุญ!";
        productError.style.color = "green";
        productError.style.display = "block";
        await loadProducts(selectedBotId);
      } catch (err) {
        console.error("ุฎุทุฃ ูู ุญุฐู ุงูููุชุฌ:", err);
      }
    }
  };

  // --- Event Listeners ---
  toggleInstructionsBtn.addEventListener("click", () => {
    instructionsContainer.style.display = instructionsContainer.style.display === "none" ? "block" : "none";
    toggleInstructionsBtn.textContent = instructionsContainer.style.display === "none" ? "ุฅุธูุงุฑ ุงูุชุนูููุงุช" : "ุฅุฎูุงุก ุงูุชุนูููุงุช";
  });

  storeForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    await saveStoreSettings(selectedBotId);
  });

  productForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    await saveProduct(selectedBotId);
  });

  // --- Initial Load ---
  await loadStoreStatus(selectedBotId);
  await loadStoreSettings(selectedBotId);
  await loadProducts(selectedBotId);
}

// Make loadStoreManagerPage globally accessible
window.loadStoreManagerPage = loadStoreManagerPage;

// Ensure the function is available even if called early
if (window.loadStoreManagerPage) {
  console.log('โ loadStoreManagerPage is defined and ready');
} else {
  console.error('โ loadStoreManagerPage is not defined');
}
