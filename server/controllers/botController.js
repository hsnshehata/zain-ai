const Bot = require('../models/Bot');
const express = require('express');

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© timestamp Ù„Ù„Ù€ logs
const getTimestamp = () => new Date().toISOString();

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© Ø§Ù„ÙˆÙ‚Øª (HH:mm)
const isValidTimeFormat = (time) => {
  const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
  return timeRegex.test(time);
};

// Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…Ø«Ù„ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„)
exports.getSettings = async (req, res) => {
  try {
    const botId = req.params.id;
    console.log(`[${getTimestamp()}] Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª | Bot ID: ${botId}`);

    const bot = await Bot.findById(botId);
    if (!bot) {
      console.log(`[${getTimestamp()}] âš ï¸ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | Bot ID: ${botId}`);
      return res.status(404).json({ success: false, message: 'Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
    }

    const settings = {
      workingHours: bot.workingHours,
      messagingOptinsEnabled: bot.messagingOptinsEnabled,
      messageReactionsEnabled: bot.messageReactionsEnabled,
      messagingReferralsEnabled: bot.messagingReferralsEnabled,
      messageEditsEnabled: bot.messageEditsEnabled,
      inboxLabelsEnabled: bot.inboxLabelsEnabled,
      commentsRepliesEnabled: bot.commentsRepliesEnabled,
    };

    console.log(`[${getTimestamp()}] âœ… ØªÙ… Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­:`, settings);
    res.status(200).json({ success: true, data: settings });
  } catch (err) {
    console.error(`[${getTimestamp()}] âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª:`, err.message, err.stack);
    res.status(500).json({ success: false, message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
  }
};

// ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¹Ø§Ù…Ø©
exports.updateSettings = async (req, res) => {
  try {
    const botId = req.params.id;
    const { workingHours, messagingOptinsEnabled, messageReactionsEnabled, messagingReferralsEnabled, messageEditsEnabled, inboxLabelsEnabled, commentsRepliesEnabled } = req.body;

    console.log(`[${getTimestamp()}] ğŸ“ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª | Bot ID: ${botId} | Data:`, req.body);

    const bot = await Bot.findById(botId);
    if (!bot) {
      console.log(`[${getTimestamp()}] âš ï¸ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | Bot ID: ${botId}`);
      return res.status(404).json({ success: false, message: 'Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
    }

    if (req.user.role !== 'superadmin' && bot.userId.toString() !== req.user.userId.toString()) {
      console.log(`[${getTimestamp()}] âš ï¸ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… | Bot User ID: ${bot.userId} | Request User ID: ${req.user.userId}`);
      return res.status(403).json({ success: false, message: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª' });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© workingHours Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    if (workingHours) {
      if (!workingHours.start || !workingHours.end || !isValidTimeFormat(workingHours.start) || !isValidTimeFormat(workingHours.end)) {
        console.log(`[${getTimestamp()}] âš ï¸ ØµÙŠØºØ© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© | Bot ID: ${botId} | Working Hours:`, workingHours);
        return res.status(400).json({ success: false, message: 'ØµÙŠØºØ© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† HH:mm' });
      }
      bot.workingHours = workingHours;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù€ Boolean
    const booleanFields = {
      messagingOptinsEnabled,
      messageReactionsEnabled,
      messagingReferralsEnabled,
      messageEditsEnabled,
      inboxLabelsEnabled,
      commentsRepliesEnabled,
    };

    let hasChanges = false;
    for (const [key, value] of Object.entries(booleanFields)) {
      if (value !== undefined) {
        if (typeof value !== 'boolean') {
          console.log(`[${getTimestamp()}] âš ï¸ Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© | Bot ID: ${botId} | Field: ${key} | Value: ${value}`);
          return res.status(400).json({ success: false, message: `Ø§Ù„Ù‚ÙŠÙ…Ø© ${key} ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† true Ø£Ùˆ false` });
        }
        if (bot[key] !== value) {
          bot[key] = value;
          hasChanges = true;
        }
      }
    }

    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙ‚Ø· Ù„Ùˆ ÙÙŠÙ‡ ØªØºÙŠÙŠØ±Ø§Øª ÙØ¹Ù„ÙŠØ©
    if (hasChanges || (workingHours && (workingHours.start !== bot.workingHours.start || workingHours.end !== bot.workingHours.end))) {
      await bot.save();
      console.log(`[${getTimestamp()}] âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­ | Bot ID: ${botId}`);
    } else {
      console.log(`[${getTimestamp()}] âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§ | Bot ID: ${botId}`);
    }

    const updatedSettings = {
      workingHours: bot.workingHours,
      messagingOptinsEnabled: bot.messagingOptinsEnabled,
      messageReactionsEnabled: bot.messageReactionsEnabled,
      messagingReferralsEnabled: bot.messagingReferralsEnabled,
      messageEditsEnabled: bot.messageEditsEnabled,
      inboxLabelsEnabled: bot.inboxLabelsEnabled,
      commentsRepliesEnabled: bot.commentsRepliesEnabled,
    };

    res.status(200).json({ success: true, data: updatedSettings });
  } catch (err) {
    console.error(`[${getTimestamp()}] âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª:`, err.message, err.stack);
    res.status(500).json({ success: false, message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
  }
};

// Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…
exports.getInstagramSettings = async (req, res) => {
  try {
    const botId = req.params.id;
    console.log(`[${getTimestamp()}] Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… | Bot ID: ${botId}`);

    const bot = await Bot.findById(botId);
    if (!bot) {
      console.log(`[${getTimestamp()}] âš ï¸ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | Bot ID: ${botId}`);
      return res.status(404).json({ success: false, message: 'Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
    }

    const instagramSettings = {
      instagramMessagingOptinsEnabled: bot.instagramMessagingOptinsEnabled,
      instagramMessageReactionsEnabled: bot.instagramMessageReactionsEnabled,
      instagramMessagingReferralsEnabled: bot.instagramMessagingReferralsEnabled,
      instagramMessageEditsEnabled: bot.instagramMessageEditsEnabled,
      instagramInboxLabelsEnabled: bot.instagramInboxLabelsEnabled,
      instagramCommentsRepliesEnabled: bot.instagramCommentsRepliesEnabled,
    };

    console.log(`[${getTimestamp()}] âœ… ØªÙ… Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ | Bot ID: ${botId} | Settings:`, instagramSettings);
    res.status(200).json({ success: true, data: instagramSettings });
  } catch (err) {
    console.error(`[${getTimestamp()}] âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…:`, err.message, err.stack);
    res.status(500).json({ success: false, message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
  }
};

// ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…
exports.updateInstagramSettings = async (req, res) => {
  try {
    const botId = req.params.id;
    const { instagramMessagingOptinsEnabled, instagramMessageReactionsEnabled, instagramMessagingReferralsEnabled, instagramMessageEditsEnabled, instagramInboxLabelsEnabled, instagramCommentsRepliesEnabled } = req.body;

    console.log(`[${getTimestamp()}] ğŸ“ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… | Bot ID: ${botId} | Data:`, req.body);

    const bot = await Bot.findById(botId);
    if (!bot) {
      console.log(`[${getTimestamp()}] âš ï¸ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | Bot ID: ${botId}`);
      return res.status(404).json({ success: false, message: 'Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
    }

    if (req.user.role !== 'superadmin' && bot.userId.toString() !== req.user.userId.toString()) {
      console.log(`[${getTimestamp()}] âš ï¸ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… | Bot User ID: ${bot.userId} | Request User ID: ${req.user.userId}`);
      return res.status(403).json({ success: false, message: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª' });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù€ Boolean
    const booleanFields = {
      instagramMessagingOptinsEnabled,
      instagramMessageReactionsEnabled,
      instagramMessagingReferralsEnabled,
      instagramMessageEditsEnabled,
      instagramInboxLabelsEnabled,
      instagramCommentsRepliesEnabled,
    };

    let hasChanges = false;
    for (const [key, value] of Object.entries(booleanFields)) {
      if (value !== undefined) {
        if (typeof value !== 'boolean') {
          console.log(`[${getTimestamp()}] âš ï¸ Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© | Bot ID: ${botId} | Field: ${key} | Value: ${value}`);
          return res.status(400).json({ success: false, message: `Ø§Ù„Ù‚ÙŠÙ…Ø© ${key} ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† true Ø£Ùˆ false` });
        }
        if (bot[key] !== value) {
          bot[key] = value;
          hasChanges = true;
        }
      }
    }

    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙ‚Ø· Ù„Ùˆ ÙÙŠÙ‡ ØªØºÙŠÙŠØ±Ø§Øª ÙØ¹Ù„ÙŠØ©
    if (hasChanges) {
      await bot.save();
      console.log(`[${getTimestamp()}] âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ | Bot ID: ${botId}`);
    } else {
      console.log(`[${getTimestamp()}] âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§ | Bot ID: ${botId}`);
    }

    const updatedInstagramSettings = {
      instagramMessagingOptinsEnabled: bot.instagramMessagingOptinsEnabled,
      instagramMessageReactionsEnabled: bot.instagramMessageReactionsEnabled,
      instagramMessagingReferralsEnabled: bot.instagramMessagingReferralsEnabled,
      instagramMessageEditsEnabled: bot.instagramMessageEditsEnabled,
      instagramInboxLabelsEnabled: bot.instagramInboxLabelsEnabled,
      instagramCommentsRepliesEnabled: bot.instagramCommentsRepliesEnabled,
    };

    res.status(200).json({ success: true, data: updatedInstagramSettings });
  } catch (err) {
    console.error(`[${getTimestamp()}] âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…:`, err.message, err.stack);
    res.status(500).json({ success: false, message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
  }
};
